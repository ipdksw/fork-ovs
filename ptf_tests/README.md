# P4OVS tests using PTF framework

---

# Introduction

PTF is a Python based dataplane test framework. It is based on unittest, which
is included in the standard Python distribution. 
More details on PTF: https://github.com/p4lang/ptf 

This document is meant to provide a step by step guide on how to run the p4ovs tests using the ptf framework

---

# Directory Structure

The following directory structure is a pre-requisite to run the tests. All steps should be run from the main directory, ptf_tests.

<pre>
'''
.
├── common
│   ├── config
│   │   └── l3_exact_match_dst_ip_tap.json
│   ├── __init__.py
│   ├── lib
│   │   ├── __init__.py
│   │   └── ovs_p4ctl.py
│   ├── p4c_artifacts
│   │   └── l3_exact_match_dst_ip
│   │       ├── p4Info.txt
│   │       └── simple_l3.pb.bin
│   └── utils
│       ├── __init__.py
│       └── ovsp4ctl_utils.py
├── __init__.py
├── pre_test.sh
├── requirements.txt
└── tests
    ├── __init.py__
    └── l3_exact_match_dst_ip_with_tap_port.py

'''
</pre>

---

# Pre-requisite

P4OVS, P4SDE and P4C should be installed before running the tests

---

# Installing Dependencies

---
~ cd <ptf_tests>

~ python3 -m pip install -r requirements.txt

---

# Pre Test

---
~ source pre_test.sh <SDE_INSTALL_PATH> <P4OVS_INSTALL_PATH> [P4OVS_DEPS_INSTALL_PATH]

---

# Running the test


## Running a single test

---
~ ptf --test-dir tests/ <test_script_name_without_extension> --pypath $PWD --test-params="config_json='<config json file name>'" --platform=dummy

E.g. ptf --test-dir tests/ l3_exact_match_with_tap_port --pypath $PWD --test-params="config_json='l3_exact_match_with_tap.json'" --platform=dummy

---

## Running tests in a suite

To run multiple tests in a suite, we need to use the script p4ovs_test_runner.py.

E.g. python p4ovs_test_runner.py -f tests_to_run.txt -s /home/admin/djayakum/drop-1/P4SDE/install/ -o /home/admin/djayakum/drop-1/P4OVS -vm /home/admin2/vm/ubuntu-20.04-server-cloudimg-amd64_1.img,/home/admin2/vm/ubuntu-20.04-server-cloudimg-amd64_2.img -bdf 0000:af:00.0,0000:af:00.1  --log_file ptf_tests.log --verbose

---
~ python p4ovs_test_runner.py -h

usage: p4ovs_test_runner.py [-h] -f FILE -s P4SDE_INSTALL_PATH -o P4OVS_INSTALL_PATH [-vm VM_LOCATION_LIST] [-bdf PCI_BDF] [-d P4DEP_INSTALL_PATH] [-l LOG_FILE] [--verbose]


mandatory arguments:

    -f FILE, --file FILE  Reads the test suite file default location ptf_tests/ . if kept in a different location, then mention absolute file name. This

                        file consists tests scripts to run (without .py extension) and the corresponding "test-params"

    -s P4SDE_INSTALL_PATH, --p4sde_install_path P4SDE_INSTALL_PATH

                        Absolute P4SDE Install path

    -o P4OVS_INSTALL_PATH, --p4ovs_install_path P4OVS_INSTALL_PATH

                        Absolute P4OVS Install path



optional arguments:

    -h, --help            show this help message and exit

    -vm VM_LOCATION_LIST, --vm_location_list VM_LOCATION_LIST

                        Absolute vm image location path(s) separated by comma

    -bdf PCI_BDF, --pci_bdf PCI_BDF

                        PCI BDF list separated by comma

    -d P4DEP_INSTALL_PATH, --p4dep_install_path P4DEP_INSTALL_PATH

                        Absolute P4OVS Dependency Install path

    -l LOG_FILE, --log_file LOG_FILE

                        name of the log file, by default located in ptf_tests/

    --verbose prints ptf logs in the console

---

# Post Test

[TBD]

# Reading Results

## Log File
All ptf autogenerated logs can be found at ptf_tests/ptf.log

## Console Output

Individual steps start with "PASS" or "FAIL" which shows their execution status.

Example

---
FAIL: ovs-p4ctl set pipe Failed with error: P4Runtime RPC error (FAILED_PRECONDITION): Only a single forwarding pipeline can be pushed for any node so far.

Scenario1 : l3 exact match with destination IP

Adding rule for port 0 and 1 with destination IP

PASS: ovs-p4ctl add entry: headers.ipv4.dst_addr=1.1.1.1,action=ingress.send(0)

PASS: ovs-p4ctl add entry: headers.ipv4.dst_addr=1.1.1.2,action=ingress.drop(1)

Test has PASSED

---

## Consolidated output

The consolidated output is applicable only when running multiple tests. Refer to "Running tests in a suite".
To store the test logs we need to provide -l or --log_file option with the name of the log file.
Additionally, if --verbose is enabled, the log file will contain the full execution logs, 
else it will contain a summary.

---

E.g.

---

====================

Summary

====================

l2_exact_match_with_tap_port : PASSED

l3_action_profile_with_tap_ports : PASSED

l3_action_selector_with_tap_ports : PASSED

l3_action_selector_with_tap_ports : PASSED

l3_exact_match_with_tap_port : PASSED




Ran 5 test(s), 5 Passed, 0 Failed.

---
